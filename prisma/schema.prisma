// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TUTOR
  STUDENT
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

enum PaymentState {
  PENDING           // Payment initiated but not confirmed
  PROCESSING        // Being processed by payment gateway
  COMPLETED         
  FAILED            
  REFUNDED          
  CANCELLED         
  EXPIRED           // Payment link/session expired
}


enum PaymentMethod {
  CARD
  BANK_TRANSFER
  USSD
  MOBILE_MONEY
  QR_CODE
}

enum InstallmentPlan {
  FULL_PAYMENT      
  TWO_INSTALLMENTS  
}

enum TransactionType {
  FULL_PAYMENT
  FIRST_INSTALLMENT
  SECOND_INSTALLMENT
}

enum RefundStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}



enum CohortStatus {
  UPCOMING
  ONGOING
  COMPLETED
}

enum AssignmentStatus {
  PENDING
  SUBMITTED
  GRADED
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
}

enum ActivityAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
}

enum AttendanceLogType {
  CHECK_IN
  CHECK_OUT
}

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  admins Admin[]
  tutors Tutor[]

  @@index([name])
}

// USER MANAGEMENT

model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  password           String?
  firstName          String
  lastName           String
  phoneNumber        String?
  profileImage       String?
  role               UserRole
  isEmailVerified    Boolean   @default(false)
  // isPhoneVerified       Boolean   @default(false)
  googleId           String?   @unique
  emailNotifications Boolean   @default(true)
  smsNotifications   Boolean   @default(false)
  isActive           Boolean   @default(true)
  lastLogin          DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  admin              Admin?
  tutor              Tutor?
  student            Student?
  activities         ActivityLog[]
  announcementLikes  AnnouncementLike[]
  postLikes          PostLike[]
  posts              Post[]
  comments           Comment[]
  attendanceLogs     AttendanceLog[]
  communitiesCreated Community[]
  communityMembers   CommunityMember[]
  payments           Payment[]

  @@index([email])
  @@index([role])
}

model Admin {
  id           String   @id @default(uuid())
  userId       String   @unique
  staffId      String   @unique
  departmentId String?
  permissions  String[] // JSON array of specific permissions
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [departmentId], references: [id])

  coursesCreated Course[]
  cohortsCreated Cohort[]

  announcementsCreated Announcement[]
  qrCodesCreated       AttendanceQRCode[]
  // certificatesIssued    Certificate[]

  @@index([staffId])
  @@index([departmentId])
}

model Tutor {
  id                String   @id @default(uuid())
  userId            String   @unique
  staffId           String   @unique
  departmentId      String?
  bio               String?
  expertise         String[]
  yearsOfExperience Int?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [departmentId], references: [id])

  cohorts          Cohort[]
  assignments      Assignment[]
  submissions      AssignmentSubmission[] @relation("GradedBy")
  attendanceMarked Attendance[]
  announcements    Announcement[]

  @@index([staffId])
}

model Student {
  id               String    @id @default(uuid())
  userId           String    @unique
  studentId        String    @unique
  dateOfBirth      DateTime?
  address          String?
  emergencyContact String?
  enrollmentDate   DateTime  @default(now())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  enrollments          Enrollment[]
  payments             Payment[]
  submissions          AssignmentSubmission[]
  attendance           Attendance[]
  certificates         Certificate[]
  communityMemberships CommunityMember[]

  @@index([studentId])
}

// ACADEMIC MANAGEMENT

model Course {
  id          String   @id @default(uuid())
  title       String
  description String
  syllabus    String[]
  coverImage  String?
  category    String?
  price       Decimal  @db.Decimal(10, 2)
  duration    Int // in weeks
  isActive    Boolean  @default(true)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy Admin @relation(fields: [createdById], references: [id])

  cohorts      Cohort[]
  enrollments  Enrollment[]
  payments     Payment[]
  certificates Certificate[]

  @@index([title])
  @@index([category])
  @@index([isActive])
}

model Cohort {
  id          String       @id @default(uuid())
  courseId    String
  tutorId     String
  name        String
  startDate   DateTime
  endDate     DateTime
  status      CohortStatus @default(UPCOMING)
  // meetingLink           String?       // Google Meet/Zoho link
  createdById String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  course    Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tutor     Tutor  @relation(fields: [tutorId], references: [id])
  createdBy Admin  @relation(fields: [createdById], references: [id])

  enrollments       Enrollment[]
  materials         Material[]
  timetables        Timetable[]
  assignments       Assignment[]
  attendance        Attendance[]
  payments          Payment[]
  certificates      Certificate[]
  announcements     Announcement[]
  cohorts           AnnouncementCohort[]
  attendanceQRCodes AttendanceQRCode[]
  attendanceLogs    AttendanceLog[]

  @@index([courseId])
  @@index([tutorId])
  @@index([status])
}

model Enrollment {
  id             String           @id @default(uuid())
  studentId      String
  courseId       String
  cohortId       String
  enrollmentDate DateTime         @default(now())
  status         EnrollmentStatus @default(ACTIVE)
  progress       Int              @default(0) // 0-100%

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id])
  cohort  Cohort  @relation(fields: [cohortId], references: [id], onDelete: Cascade)

  @@unique([studentId, cohortId])
  @@index([studentId])
  @@index([cohortId])
  @@index([status])
}

model Material {
  id          String   @id @default(uuid())
  cohortId    String
  title       String
  description String?
  type        String // video, document, link
  url         String
  publicId    String?
  order       Int      @default(0)
  uploadedAt  DateTime @default(now())

  cohort Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)

  @@index([cohortId])
}

model Timetable {
  id        String   @id @default(uuid())
  cohortId  String
  dayOfWeek String
  startTime String // HH:mm format
  endTime   String
  // topic                 String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cohort         Cohort          @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  attendanceLogs AttendanceLog[]

  @@index([cohortId])
}

model Assignment {
  id          String   @id @default(uuid())
  cohortId    String
  tutorId     String
  title       String
  description String
  dueDate     DateTime
  totalMarks  Int
  attachments String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cohort Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  tutor  Tutor  @relation(fields: [tutorId], references: [id])

  submissions AssignmentSubmission[]

  @@index([cohortId])
  @@index([tutorId])
  @@index([dueDate])
}

model AssignmentSubmission {
  id           String           @id @default(uuid())
  assignmentId String
  studentId    String
  fileUrl      String
  filePublicId String? // New field for Cloudinary
  submittedAt  DateTime         @default(now())
  status       AssignmentStatus @default(SUBMITTED)
  grade        Int?
  feedback     String?
  gradedById   String?
  gradedAt     DateTime?

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  gradedBy   Tutor?     @relation("GradedBy", fields: [gradedById], references: [id])

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
}

model Attendance {
  id         String           @id @default(uuid())
  cohortId   String
  studentId  String
  date       DateTime
  status     AttendanceStatus
  markedById String
  createdAt  DateTime         @default(now())

  cohort   Cohort  @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  student  Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  markedBy Tutor   @relation(fields: [markedById], references: [id])

  @@unique([cohortId, studentId, date])
  @@index([cohortId])
  @@index([studentId])
  @@index([date])
}

// COMMUNITY 
model Community {
  id          String   @id @default(uuid())
  name        String
  description String
  coverImage  String?
  isPrivate   Boolean  @default(false)
  createdById String // Admin or Tutor ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Updated relations
  members CommunityMember[]
  posts   Post[]
  user    User?             @relation(fields: [userId], references: [id])
  userId  String?

  @@index([name])
}

model CommunityMember {
  id          String   @id @default(uuid())
  communityId String
  userId      String
  joinedAt    DateTime @default(now())

  // Relations
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  student   Student?  @relation(fields: [studentId], references: [id])
  studentId String?

  @@unique([communityId, userId])
  @@index([communityId])
  @@index([userId])
}

model Post {
  id          String   @id @default(uuid())
  communityId String
  authorId    String // User.id
  content     String   @db.Text
  attachments String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)

  likes    PostLike[]
  comments Comment[]

  @@index([communityId])
  @@index([authorId])
}

model Comment {
  id        String   @id @default(uuid())
  postId    String
  authorId  String // Refers to User.id
  parentId  String? // For threaded replies
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post    Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author  User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
}

model PostLike {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
}

model Announcement {
  id            String   @id @default(uuid())
  title         String
  content       String
  isGlobal      Boolean  @default(false) // true = for all users, false = specific cohorts
  createdById   String
  createdByType String
  tutorId       String?
  adminId       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  admin Admin? @relation(fields: [adminId], references: [id], onDelete: SetNull)
  tutor Tutor? @relation(fields: [tutorId], references: [id], onDelete: SetNull)

  cohorts  AnnouncementCohort[]
  likes    AnnouncementLike[]
  cohort   Cohort?              @relation(fields: [cohortId], references: [id])
  cohortId String?

  @@index([createdById])
  @@index([isGlobal])
  @@index([createdAt])

}

model AnnouncementCohort {
  id             String   @id @default(uuid())
  announcementId String
  cohortId       String
  createdAt      DateTime @default(now())

  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  cohort       Cohort       @relation(fields: [cohortId], references: [id], onDelete: Cascade)

  @@unique([announcementId, cohortId])
  @@index([announcementId])
  @@index([cohortId])

}

model AnnouncementLike {
  id             String   @id @default(uuid())
  announcementId String
  userId         String
  createdAt      DateTime @default(now())

  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([userId])
}

// PAYMENTS & FINANCE

model Payment {
  id                    String            @id @default(uuid())
  
  // Unique identifiers
  reference             String            @unique //  internal reference
  paystackReference     String?           @unique // Paystack's reference
  idempotencyKey        String            @unique 
  
  // Relations
  studentId             String
  userId                String            
  cohortId              String
  courseId              String
  
  // Amount details (stored in kobo)
  totalAmountKobo       Int               // Total course price in kobo
  paidAmountKobo        Int               @default(0) // Amount paid so far
  balanceKobo           Int               // Remaining balance
  
  // Payment details
  status                PaymentState     @default(PENDING)
  paymentMethod         PaymentMethod?
  currency              String            @default("NGN")
  
  // Installment details
  installmentPlan       InstallmentPlan   @default(FULL_PAYMENT)
  
  // First installment
  firstInstallmentKobo      Int?          // Amount for first installment
  firstInstallmentPaidAt    DateTime?
  firstInstallmentReference String?
  
  // Second installment
  secondInstallmentKobo     Int?          // Remaining amount
  secondInstallmentDueDate  DateTime?
  secondInstallmentPaidAt   DateTime?
  secondInstallmentReference String?
  
  // Payment gateway details
  paystackAuthUrl       String?           // Paystack Authorization URL  
  paystackAccessCode    String?
  paystackChannels      String[]          // Allowed payment channels
  
  // Metadata
  ipAddress             String?
  userAgent             String?
  metadata              Json?           
  
  // Audit trail
  initiatedAt           DateTime          @default(now())
  confirmedAt           DateTime?         // When payment was confirmed
  expiresAt             DateTime?         // Payment session expiry
  lastCheckedAt         DateTime?         // Last webhook/verification check
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relations
  student               Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  user                  User              @relation(fields: [userId], references: [id])
  cohort                Cohort            @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  course                Course            @relation(fields: [courseId], references: [id])
  
  // Child records
  transactions          PaymentTransaction[]
  refunds               PaymentRefund[]
  auditLogs             PaymentAuditLog[]

  @@index([reference])
  @@index([paystackReference])
  @@index([studentId])
  @@index([cohortId])
  @@index([status])
  @@index([installmentPlan])
  @@index([createdAt])
  @@index([idempotencyKey])
 
}

// Tracking transaction attempt 
model PaymentTransaction {
  id                    String            @id @default(uuid())
  paymentId             String
  
  // Transaction details
  reference             String            @unique // Transaction-specific reference
  paystackReference     String?           // Paystack transaction reference
  type                  TransactionType   // 'FIRST_INSTALLMENT', 'SECOND_INSTALLMENT', 'FULL_PAYMENT'
  
  // Amount (in kobo)
  amountKobo            Int
  currency              String            @default("NGN")
  
  // Status
  status                PaymentState    @default(PENDING)
  paymentMethod         PaymentMethod?
  
  // Gateway response
  gatewayResponse       Json?             // Full response from Paystack
  gatewayMessage        String?
  gatewayCode           String?
  
  // Timestamps
  initiatedAt           DateTime          @default(now())
  completedAt           DateTime?
  failedAt              DateTime?
  
  // Metadata
  ipAddress             String?
  channel               String?           // card, bank, ussd...
  
  // Relations
  payment               Payment           @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([reference])
  @@index([paystackReference])
  @@index([status])
  @@index([initiatedAt])

}

// Tracks refunds
model PaymentRefund {
  id                    String            @id @default(uuid())
  paymentId             String
  
  // Refund details
  reference             String            @unique
  amountKobo            Int               // Amount refunded in kobo
  reason                String
  
  // Status
  status                RefundStatus @default(PENDING)  // PENDING, PROCESSING, COMPLETED, FAILED
  
  // Gateway details
  paystackReference     String?
  gatewayResponse       Json?
  
  // Audit
  initiatedBy           String            // Admin user ID
  initiatedAt           DateTime          @default(now())
  completedAt           DateTime?
  
  // Relations
  payment               Payment           @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([reference])
  @@index([status])

}

//  audit log for all payment activities
model PaymentAuditLog {
  id                    String            @id @default(uuid())
  paymentId             String
  
  // Action details
  action                String            // INITIATED, VERIFIED, COMPLETED, FAILED, REFUNDED...
  actor                 String?           // User/System that performed action
  actorType             String            // USER, SYSTEM, WEBHOOK, ADMIN
  
  // Details
  description           String
  previousStatus        String?
  newStatus             String?
  
  // Metadata
  metadata              Json?
  ipAddress             String?
  
  // Timestamp
  timestamp             DateTime          @default(now())
  
  // Relations
  payment               Payment           @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([action])
  @@index([timestamp])

}

// CERTIFICATES

model Certificate {
  id                String   @id @default(uuid())
  studentId         String
  courseId          String
  cohortId          String
  certificateNumber String   @unique
  issueDate         DateTime @default(now())
  completionDate    DateTime
  grade             String?
  pdfUrl            String
  issuedById        String

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id])
  cohort  Cohort  @relation(fields: [cohortId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([certificateNumber])
}

// ACTIVITY LOGS

model ActivityLog {
  id          String         @id @default(uuid())
  userId      String
  action      ActivityAction
  entity      String // User, Course, Payment, etc.
  entityId    String?
  description String
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
}

model AttendanceQRCode {
  id           String   @id @default(uuid())
  token        String   @unique // Unique token for scanning
  locationName String // e.g. "Front Desk", "Main Hall"
  cohortId     String? // Optional: link to a specific cohort
  isActive     Boolean  @default(true)
  createdById  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  createdBy Admin           @relation(fields: [createdById], references: [id])
  cohort    Cohort?         @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  logs      AttendanceLog[]

  @@index([token])
  @@index([cohortId])
}

model AttendanceLog {
  id           String            @id @default(uuid())
  userId       String
  qrCodeId     String
  cohortId     String? // Optional: which cohort session was this for?
  timetableId  String? // Optional: link to specific timetable entry
  type         AttendanceLogType
  locationName String // Denormalized for historical record
  timestamp    DateTime          @default(now())

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  qrCode    AttendanceQRCode @relation(fields: [qrCodeId], references: [id])
  cohort    Cohort?          @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  timetable Timetable?       @relation(fields: [timetableId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([qrCodeId])
  @@index([cohortId])
  @@index([timetableId])
  @@index([timestamp])
}
